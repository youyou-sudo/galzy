name: Build and Push WEB Docker Image

on:
  push:
    branches:
      - main
    paths:
      - "apps/web/**"
      - "packages/**"
      - "bun.lock"
      - "package.json"
      - ".github/workflows/build-web.yml"

jobs:
  build-web:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Build WEB Docker image
        run: bun scripts/run docker:web

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Push WEB image
        run: |
          VERSION_WEB=$(docker images mono-web --format "{{.Tag}}" | head -n 1 || true)
          echo "WEB version: $VERSION_WEB"

          if [ -n "$VERSION_WEB" ]; then
            docker tag mono-web:$VERSION_WEB ghcr.io/${{ github.repository_owner }}/mono-web:$VERSION_WEB
            docker tag mono-web:$VERSION_WEB ghcr.io/${{ github.repository_owner }}/mono-web:latest
            docker push ghcr.io/${{ github.repository_owner }}/mono-web:$VERSION_WEB
            docker push ghcr.io/${{ github.repository_owner }}/mono-web:latest
          else
            echo "No WEB image built, skipping push"
            exit 0
          fi

      - name: Trigger WEB Webhook Deploy
        if: success()
        run: |
          curl -X POST "${{ secrets.DEPLOY_WEBHOOK_WEB }}"

name: Build and Push API Docker Image

on:
  push:
    branches:
      - main
    paths:
      - "apps/api/**"
      - "packages/**"
      - "bun.lock"
      - "package.json"
      - ".github/workflows/build-api.yml"

jobs:
  build-api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Build API Docker image
        run: bun scripts/run docker:api

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Push API image
        run: |
          VERSION_API=$(docker images mono-api --format "{{.Tag}}" | head -n 1 || true)
          echo "API version: $VERSION_API"

          if [ -n "$VERSION_API" ]; then
            docker tag mono-api:$VERSION_API ghcr.io/${{ github.repository_owner }}/mono-api:$VERSION_API
            docker tag mono-api:$VERSION_API ghcr.io/${{ github.repository_owner }}/mono-api:latest
            docker push ghcr.io/${{ github.repository_owner }}/mono-api:$VERSION_API
            docker push ghcr.io/${{ github.repository_owner }}/mono-api:latest
          else
            echo "No API image built, skipping push"
            exit 0
          fi

      - name: Trigger API Webhook Deploy
        if: success()
        run: |
          curl -X POST "${{ secrets.DEPLOY_WEBHOOK_API }}" \
            -H "Content-Type: application/json" \
            -H "x-github-event: registry_package" \
            -d '{"registry_package": {"package_version": {"package_url": "ghcr.io/youyou-sudo/mono-api:latest"}}}'
